# NFTDriveData ビューア

## 概要

`sample-get-nftdriveData.html` は、Symbol ブロックチェーンに保存されたNFTDriveデータを取得・表示するWebアプリケーションです。アグリゲートトランザクションに格納された画像・動画・PDFなどのデータを、復号化してプレビュー表示できます。

## 機能

### 1. NFTDriveデータ自動取得
- **URLパラメータ対応**: `?address=XXX` でアドレスを指定して自動取得
- **プロンプト入力**: パラメータがない場合、手動でアドレスを入力
- **ネットワーク自動判定**: アドレスの最初の文字で mainnet/testnet を自動選択
  - `N` で始まる → mainnet ノード使用
  - `T` で始まる → testnet ノード使用

### 2. マルチノード対応（信頼性向上）
- **ノード障害時の自動フェイルオーバー**: 1つのノードが落ちても他のノードで自動復帰
- **リトライ機構**: 通信障害時は段階的リトライ（3回まで）
- **タイムアウト制御**: 応答のない無駄な待機を5秒で強制終了
- **失敗ノード隔離**: 既に失敗したノードをスキップして効率化

### 3. データ形式対応
- **通常のBase64データ**: `data:image/png;base64,...` 形式
- **暗号化データ**: Salt付きBase64（`U2FsdGVkX1...`）→ パスワード入力で復号化

### 4. メディアプレビュー
- **画像**: PNG, JPEG, GIF, WebP → ズーム・ドラッグスクロール対応
- **動画**: MP4, WebM → 再生コントロール付き
- **音声**: MP3, WAV, OGG → 再生コントロール付き
- **PDF**: iframe での埋め込み表示
- **テキスト**: 暗号化データとして表示

### 5. 高度な画像操作
- **ズーム機能**: マウスホイール で最大5倍までズーム
- **ドラッグスクロール**: ズーム時にマウスドラッグで移動
- **ダブルクリック**: ズームをリセット

### 6. ヘッダー情報表示
- **アコーディオン展開**: JSON形式でメタデータを表示
  - MIME タイプ
  - ID、シリアル番号
  - オーナー、メッセージ
  - 拡張フィールド（10個まで）
  - ファイルサイズ

## 使い方

### 方法1: URLパラメータで自動取得

```
https://example.com/sample-get-nftdriveData.html?address=NBLTM72ULZH52YKJSV2VFZH44OKL2XFXXJ3MDZQ
```

ページを開くと自動的にデータを取得して表示します。

### 方法2: プロンプト入力

URLパラメータなしでアクセス：

```
https://example.com/sample-get-nftdriveData.html
```

プロンプトが表示されるので、アドレスを入力して取得します。

### 方法3: 手動入力後の自動取得

1. ページを開く
2. プロンプトにSymbolアドレスを入力
3. ボタンクリック時に自動取得

## 暗号化データの復号化

NFTDriveデータが暗号化されている場合：

1. ページロード時に自動検出
2. パスワード入力プロンプトが表示
3. パスワードを入力すると自動復号化
4. 復号化後のデータを表示

**暗号化検出の仕組み**: データが `U2FsdGVkX1` で始まる場合、CryptoJS.AES で暗号化されていると判定します。

## 画像操作ガイド

### PC での操作

| 操作 | 説明 |
|------|------|
| **マウスホイール上** | 画像を拡大（最大5倍） |
| **マウスホイール下** | 画像を縮小 |
| **マウスドラッグ** | ズーム時に画像を移動 |
| **ダブルクリック** | ズームをリセット（1倍に戻す） |

### モバイル での操作

| 操作 | 説明 |
|------|------|
| **ピンチイン** | 画像を拡大（2本指で広げる） |
| **ピンチアウト** | 画像を縮小（2本指で閉じる） |

## ネットワーク設定

### Mainnet ノード一覧
```javascript
[
  "https://sn1.msus-symbol.com:3001",
  "https://ichigo-node.xyz:3001",
  "https://0-0-0-0.symbol-nodes.jp:3001",
  "https://01.symbol-node.com:3001",
  "https://03.symbol-node.com:3001",
  "https://symbol-node.teritaris.net:3001"
]
```

### Testnet ノード一覧
```javascript
[
  "https://201-sai-dual.symboltest.net:3001",
  "https://testnet1.symbol-mikun.net:3001",
  "https://testnet2.symbol-mikun.net:3001",
  "https://sym-test-03.opening-line.jp:3001"
]
```

## 技術仕様

### アグリゲートトランザクション構造

NFTDriveデータは以下のインナートランザクション構成を持ちます：

```
インナートランザクション:
  [0]: メッセージ番号（最初の転送トランザクション）
  [1]: オーナーアドレス
  [2]: ID
  [3]: シリアル番号
  [4]: メッセージ
  [5-14]: 拡張フィールド（10個）
  [15]: MIMEデータ または 暗号化データ（16個以上の場合）
  [16+]: データペイロード
```

### フィルタリング条件

以下の条件でアグリゲートトランザクションを処理対象に選定：

- ✅ 転送トランザクション（type: 16724）を含む
- ❌ アカウント制限トランザクション（type: 16720）のみは除外
- ❌ モザイク定義・供給変更などは自動除外

### エラーハンドリング

| エラー | 対応 |
|--------|------|
| ノード接続失敗 | 自動で別ノードに切り替え（最大3回リトライ） |
| タイムアウト | 5秒で接続中止、次のノードを試行 |
| Base64デコード失敗 | エラーメッセージ表示、プレビュー中止 |
| 復号化失敗 | パスワード再入力プロンプト表示 |

## ブラウザ互換性

| ブラウザ | 対応状況 |
|---------|---------|
| Chrome | ✅ 対応 |
| Firefox | ✅ 対応 |
| Safari | ✅ 対応 |
| Edge | ✅ 対応 |
| IE11 | ❌ 非対応 |

## 必要なライブラリ

- `bundle.min.js` - Symbol Transaction Fetcher バンドル版
- `aes.js` - CryptoJS AES 暗号化ライブラリ

## コンソール出力

デバッグ用のコンソールログが表示されます：

```
✓ ノード接続成功: https://sn1.msus-symbol.com:3001
✓ 取得成功: abc123... (https://...)
✗ ノード接続失敗: https://testnode.com:3001 - Timeout
⚠ 3/100 ハッシュの取得に失敗しました
```

## トラブルシューティング

### Q: 「全ノードに接続できません」エラーが出る
A: インターネット接続を確認し、ファイアウォール設定を確認してください。全ノードが一時的に落ちている可能性もあります。

### Q: 「MIMEとBase64の分離に失敗しました」エラーが出る
A: そのNFTDriveデータは暗号化されています。パスワード入力プロンプトで正しいパスワードを入力してください。

### Q: 暗号化データが復号化されない
A: 入力したパスワードが異なる可能性があります。もう一度、正しいパスワードで試してください。

### Q: 画像がぼやけて見える
A: ズーム機能で拡大表示すれば、高解像度の詳細が見えます。フルオンチェーン保存の高解像度データの利点を活用できます。

## ライセンス

このコンポーネントは Symbol Transaction Fetcher に含まれます。
詳細はプロジェクトのLICENSEを参照してください。
